{% extends 'a_school_admin/dashboard-frag.html' %}
{% load static %}

{% block title %}
  Dashboard
{% endblock %}

{% block head %}
  <link rel="stylesheet" href="{% static 'a_school_admin/css/student-detail.css' %}" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block page_title %}
  <h2></h2>
  <div class="user-info">
    <h1 class="username">{{ student_profile.username|capfirst }}</h1>
  </div>
{% endblock %}

{% block content %}
  <div class="student-container">
    <div class="chart-wrapper">
      <h2>Status Overview</h2>
      <p>This shows the student's current status out of 100%.</p>
      <div class="chart-container">
        <canvas id="statusChart"></canvas>
      </div>
    </div>

    <div class="student-card">
      {% if student_profile.user_pic %}
        <img src="{{ student_profile.user_pic.url }}" alt="{{ student_profile.username }}'s profile picture" class="profile-image" />
      {% else %}
        <img src="{% static 'avatars/default-avatar.png' %}" alt="Default Avatar" class="profile-image" />
      {% endif %}

      <div class="info-grid">
        <div class="info-group">
          <span class="label">First Name</span><span class="value">{{ student_profile.user.first_name }}</span>
        </div>
        <div class="info-group">
          <span class="label">Middle Name</span><span class="value">{{ student_profile.user.middle_name }}</span>
        </div>
        <div class="info-group">
          <span class="label">Last Name</span><span class="value">{{ student_profile.user.last_name }}</span>
        </div>
        <div class="info-group">
          <span class="label">Age</span><span class="value">{{ student_profile.user.age }}</span>
        </div>
        <div class="info-group">
          <span class="label">Gender</span><span class="value">{{ student_profile.user.gender }}</span>
        </div>
        <div class="info-group">
          <span class="label">Email</span><span class="value">{{ student_profile.user.email }}</span>
        </div>
        <div class="info-group">
          <span class="label">Phone</span><span class="value">{{ student_profile.user.phone_number }}</span>
        </div>
        <div class="info-group">
          <span class="label">Best Subject</span><span class="value">Math</span>
        </div>
        <div class="info-group">
          <span class="label">Worst Subject</span><span class="value">History</span>
        </div>
        <div class="info-group">
          <span class="label">Class</span><span class="value">{{ student_class.class_name }}</span>
        </div>
        <div class="info-group">
          <span class="label">Conduct</span><span class="value">A</span>
        </div>
      </div>

      <div class="action-buttons">
        <a href="{% url 'edit_student_url' student_username=student_profile.user.username %}"><button class="edit-btn">Edit</button></a>
        <form action="{% url 'delete_student_url' student_username=student_profile.user.username %}" method="post" id="form_class">
          {% csrf_token %}
          <button type="button" onclick="showDeletePopup()" class="delete-btn">Delete</button>
        </form>
      </div>
    </div>
  </div>
{% endblock %}

{% block script %}
  <script>
    let status = 85
    Chart.register({
      id: 'centerText',
      beforeDraw(chart) {
        const { width } = chart
        const { height } = chart
        const ctx = chart.ctx
        ctx.restore()
        const fontSize = (height / 140).toFixed(2)
        ctx.font = `${fontSize}em sans-serif`
        ctx.textBaseline = 'middle'
    
        const text = `${status}%`
        const textX = Math.round((width - ctx.measureText(text).width) / 2)
        const textY = height / 2
    
        ctx.fillStyle = 'rgb(118, 212, 121)'
        ctx.fillText(text, textX, textY)
        ctx.save()
      }
    })
    const ctx = document.getElementById('statusChart').getContext('2d')
    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Completed', 'Remaining'],
        datasets: [
          {
            data: [status, 100 - status],
            backgroundColor: ['#196b21', 'rgb(184, 32, 32)'],
            borderWidth: 0
          }
        ]
      },
      options: {
        cutout: '70%',
        plugins: {
          legend: { display: false }
        }
      }
    })
  </script>
{% endblock %}
