{% extends 'a_school_admin/dashboard-frag.html' %}
{% load static %}

{% block title %}
  Students Management
{% endblock %}

{% block head %}
  <link rel="stylesheet" href="{% static 'a_school_admin/css/students-mang.css' %}" />
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css" />
{% endblock %}

{% block page_title %}
  <h2></h2>
  <div class="user-info">
    <h1 class="username">Students Management</h1>
  </div>
{% endblock %}

{% block content %}
  <!-- Add Students Method -->
  <div class="reg-portal">
    <div class="portal-grid">
      <!-- Manual Entry -->
      <article class="reg-card manual-card">
        <div class="card-ornament"></div>
        <div class="card-core">
          <div class="card-icon">
            <span class="material-symbols-outlined">fingerprint</span>
          </div>
          <h3 class="card-header">Precision Enrollment</h3>
          <p class="card-excerpt">Artisanal student registration with granular control</p>
          <div class="card-actions">
            <a href="{% url 'add_student_url' %}" class="card-cta">
              Begin Manual Process
              <span class="cta-underline"></span>
            </a>
          </div>
        </div>
        <div class="card-badge">Recommended for accuracy</div>
      </article>

      <!-- Bulk Upload -->
      <article class="reg-card bulk-card">
        <div class="card-ornament"></div>
        <div class="card-core">
          <div class="card-icon">
            <span class="material-symbols-outlined">deployed_code</span>
          </div>
          <h3 class="card-header">Batch Integration</h3>
          <p class="card-excerpt">Enterprise-grade mass enrollment via structured data</p>
          <div class="card-actions">
            <a href="{% url 'add_students_url' %}" class="card-cta">
              Initiate Bulk Sequence
              <span class="cta-underline"></span>
            </a>
          </div>
        </div>
        <div class="card-badge">XLSX optimized</div>
      </article>
    </div>
  </div>

  <!-- Top Students Table -->

  {% if students %}
    <div class="student-table-container top-student-container">
      <div class="table-header">
        <h2>Top Students</h2>
      </div>
      <table id="TopStudentsTable">
        <thead>
          <tr>
            <th>First Name</th>
            <th>Middle Name</th>
            <th>Age</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for student in students %}
            <tr>
              <td>{{ student.students.first_name }}</td>
              <td>{{ student.students.middle_name }}</td>
              <td>{{ student.class_room }}</td>
              <td class="crud">
                <a href="{% url 'student_detail_url' student_username=student.students.username %}" class="detail-btn right-btn">Detail</a>
                <a href="{% url 'edit_student_url' student_username=student.students.username %}" class="edit-btn left-btn">Edit</a>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    {% include 'fragments/no_data_box.html' with empty_title='No Mark list found. Ranking is unavialable' empty_message="There are currently no students in the system. We can't show the top students." btn_name='+ Add Student' add_url='add_student_url' %}
  {% endif %}

  <!-- Student Table -->
  {% if classrooms %}
    <div class="student-table-container">
      <div class="table-header">
        <h2>Students Table</h2>
        <a href="{% url 'add_student_url' %}"><button class="add-student-btn">Add Student</button></a>
      </div>
      <table id="studentsTable">
        <thead>
          <tr>
            <th>First Name</th>
            <th>Middle Name</th>
            <th>Class</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for classroom in classrooms %}
            {% for student in classroom.students.all %}
              <tr>
                <td>{{ student.first_name }}</td>
                <td>{{ student.middle_name }}</td>
                <td>
                  {% for student_class in student.classroom_students.all %}
                    {{ student_class.class_name }}
                  {% endfor %}
                </td>
                <td class="crud">
                  <a href="{% url 'student_detail_url' student_username=student.username %}" class="detail-btn right-btn">Detail</a>
                  <a href="{% url 'edit_student_url' student_username=student.username %}" class="edit-btn left-btn">Edit</a>
                </td>
              </tr>
            {% endfor %}
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    {% include 'fragments/no_data_box.html' with empty_title='No Students Found' empty_message="There are currently no students in the system. We can't show students tabel." btn_name='+ Add Student' add_url='add_student_url' %}
  {% endif %}

  <!-- Download Students -->
  <div class="download-container">
    <div class="download-card">
      <div class="download-icon">
        <i class="fas fa-file-excel"></i>
      </div>
      <h3>Export Student Data</h3>
      <p>Download a complete list of all students in Excel format, including their class and teacher information.</p>
      <a href="{% url 'download_students_excel_url' %}" class="download-btn"><i class="fas fa-download"></i> Download Excel</a>
    </div>
  </div>
{% endblock %}

{% block script %}
  <script src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
  <script>
    $(document).ready(function () {
      const table = $('#studentsTable').DataTable({
        responsive: true,
        initComplete: function () {
          $('.dataTables_length label')
            .contents()
            .filter(function () {
              return this.nodeType === 3
            })
            .each(function () {
              this.textContent = this.textContent.replace('entries', '').trim()
              this.textContent = this.textContent.replace('Show', '').trim()
            })
    
          $('.dataTables_filter label')
            .contents()
            .filter(function () {
              return this.nodeType === 3
            })
            .each(function () {
              this.textContent = this.textContent.replace('Search:', '').trim()
            })
    
          // Now append your <p>…
          const labelEl = document.querySelector('.dataTables_length label')
          const selectList = document.createElement('p')
          selectList.className = 'select-label'
          selectList.textContent = 'Show'
          labelEl.appendChild(selectList)
    
          // Now append your <p>…
          const labelSR = document.querySelector('.dataTables_filter label')
          const searchList = document.createElement('p')
          searchList.className = 'search-label'
          searchList.textContent = 'Search'
          labelSR.appendChild(searchList)
        }
      })
    })
    $(document).ready(function () {
      const table = $('#TopStudentsTable').DataTable({
        responsive: true,
        initComplete: function () {
          $('.dataTables_length label')
            .contents()
            .filter(function () {
              return this.nodeType === 3
            })
            .each(function () {
              this.textContent = this.textContent.replace('entries', '').trim()
              this.textContent = this.textContent.replace('Show', '').trim()
            })
    
          $('.dataTables_filter label')
            .contents()
            .filter(function () {
              return this.nodeType === 3
            })
            .each(function () {
              this.textContent = this.textContent.replace('Search:', '').trim()
            })
    
          // Now append your <p>…
          const labelEl = document.querySelector('.dataTables_length label')
          const selectList = document.createElement('p')
          selectList.className = 'select-label'
          selectList.textContent = 'Show'
          labelEl.appendChild(selectList)
    
          // Now append your <p>…
          const labelSR = document.querySelector('.dataTables_filter label')
          const searchList = document.createElement('p')
          searchList.className = 'search-label'
          searchList.textContent = 'Search'
          labelSR.appendChild(searchList)
        }
      })
    })
  </script>
{% endblock %}
